// server.js
import express from 'express';
import cors from 'cors';
import mongoose from 'mongoose';
import path from 'path';
import { fileURLToPath } from 'url';
import bcrypt from 'bcrypt';
import dotenv from 'dotenv';
dotenv.config();
const __dirname = path.dirname(fileURLToPath(import.meta.url));

// --- ุฅุนุฏุงุฏ Express ---
const app = express();
const PORT = process.env.PORT || 5000;
// --- Middleware ---
app.use(cors());
app.use(express.json({ limit: '10mb' }));

app.use(express.static(path.join(__dirname, 'public')));


const SALT_ROUNDS = 10;

// ุชุญููู ุจูุงูุงุช ุงููุดุฑู ูู ุงูุจูุฆุฉ
const loadAdmins = () => {
  const username = process.env.ADMIN_USERNAME;
  const password = process.env.ADMIN_PASSWORD;

  if (!username || !password) {
    console.error('โ ูุฌุจ ุชุญุฏูุฏ ADMIN_USERNAME ู ADMIN_PASSWORD ูู ููู .env');
    process.exit(1);
  }

  // ุชุดููุฑ ูููุฉ ุงููุฑูุฑ ุนูุฏ ุงูุชุดุบูู
  const hashedPassword = bcrypt.hashSync(password, SALT_ROUNDS);

  // ุฅุฑุฌุงุน ูุตูููุฉ ุชุญุชูู ุนูู ุงููุดุฑู (ูู ุงูุฐุงูุฑุฉ ููุท)
  return [
    {
      id: 1,
      username,
      password: hashedPassword
    }
  ];
};

// ุชุญููู ุงููุดุฑููู ุฅูู ุงูุฐุงูุฑุฉ
let admins = loadAdmins();

// --- ููุทุฉ ููุงูุฉ ุชุณุฌูู ุงูุฏุฎูู ---
app.post('/api/admin/login', async (req, res) => {
  const { username, password } = req.body;

  const admin = admins.find(a => a.username === username);
  if (!admin) {
    return res.status(401).json({ error: 'Falscher Benutzername oder falsches Passwort' });
  }

  const isMatch = await bcrypt.compare(password, admin.password);
  if (!isMatch) {
    return res.status(401).json({ error: 'Falscher Benutzername oder falsches Passwort' });
  }

  // ูุนูุฏ ุจุฑูุฒ ูุตุงุฏูุฉ ุจุณูุท (ููููู ุงุณุชุฎุฏุงู JWT ูุงุญููุง)
  res.json({ success: true, token: 'admin-auth-token-2025' });
});

// --- ุฅุนุฏุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช ---

// --- ุชุนุฑูู Schema ู Model ---
const medicalRecordSchema = new mongoose.Schema({
  servicecode: { type: String, required: true },
  idNumber: { type: String, required: true },
  name: { type: String, required: true },
  issueDate: { type: Date, required: true },
  startDate: { type: Date, required: true },
  endDate: { type: Date, required: true },
  duration: { type: Number, required: true },
  doctor: { type: String, required: true },
  jobTitle: { type: String, required: true }
}, {
  timestamps: true
});

const MedicalRecord = mongoose.model('MedicalRecord', medicalRecordSchema);




// GET /api/medical โ ุฌูุจ ุฌููุน ุงูุณุฌูุงุช
app.get('/api/medical', async (req, res) => {
  try {
    const records = await MedicalRecord.find().sort({ createdAt: -1 }); // ุงูุฃุญุฏุซ ุฃูููุง
    res.json(records);
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุฌูุจ ุงูุณุฌูุงุช:', error);
    res.status(500).json({ error: 'ูุดู ุฌูุจ ุงูุณุฌูุงุช' });
  }
});

// --- ุงููุณุงุฑุงุช (Routes) ---
app.post('/api/medical', async (req, res) => {
  try {
    const record = new MedicalRecord(req.body);
    await record.save();
    res.status(201).json({ message: 'ุชู ุญูุธ ุงูุจูุงูุงุช ุจูุฌุงุญ!', id: record._id });
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุงูุญูุธ:', error);
    res.status(400).json({ error: error.message || 'ูุดู ุญูุธ ุงูุจูุงูุงุช' });
  }
});

// --- ูุณุงุฑ ููุจุญุซ ุนู ุณุฌู ุจุงุณุชุฎุฏุงู idNumber ู servicecode ---
app.get('/api/medical/search', async (req, res) => {
  const { idNumber, servicecode } = req.query;

  // ุงูุชุญูู ูู ูุฌูุฏ ุงููุนููููู
  if (!idNumber || !servicecode) {
    return res.status(400).json({ error: 'ูุฌุจ ุชูุฑูุฑ "idNumber" ู "servicecode" ูู query parameters' });
  }

  try {
    const record = await MedicalRecord.findOne({ idNumber, servicecode });

    if (!record) {
      return res.status(404).json({ error: 'ุฎุทุฃ ูู ุงูุงุณุชุนูุงู' });
    }

    res.json(record);
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุงูุจุญุซ:', error);
    res.status(500).json({ error: 'ูุดู ูู ุฌูุจ ุงูุจูุงูุงุช' });
  }
});

// DELETE /api/medical/:id
app.delete('/api/medical/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const deleted = await MedicalRecord.findByIdAndDelete(id);

    if (!deleted) {
      return res.status(404).json({ error: 'ุงูุณุฌู ุบูุฑ ููุฌูุฏ' });
    }

    res.json({ message: 'ุชู ุงูุญุฐู ุจูุฌุงุญ' });
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุงูุญุฐู:', error);
    res.status(500).json({ error: 'ูุดู ุงูุญุฐู' });
  }
});

// PUT /api/medical/:id
app.put('/api/medical/:id', async (req, res) => {
  try {
    const { id } = req.params;
    const updatedRecord = await MedicalRecord.findByIdAndUpdate(
      id,
      req.body,
      { new: true, runValidators: true } // ูุนูุฏ ุงููููุฉ ุงููุญุฏุซุฉ ููุชุญูู ูู ุงูู schema
    );

    if (!updatedRecord) {
      return res.status(404).json({ error: 'ุงูุณุฌู ุบูุฑ ููุฌูุฏ' });
    }

    res.json(updatedRecord);
  } catch (error) {
    console.error('ุฎุทุฃ ูู ุงูุชุนุฏูู:', error);
    res.status(400).json({ error: error.message || 'ูุดู ุชุญุฏูุซ ุงูุณุฌู' });
  }
});

// GET /api/medical/:id
app.get('/api/medical/:id', async (req, res) => {
  try {
    const record = await MedicalRecord.findById(req.params.id);
    if (!record) {
      return res.status(404).json({ error: 'ุงูุณุฌู ุบูุฑ ููุฌูุฏ' });
    }
    res.json(record);
  } catch (error) {
    res.status(500).json({ error: 'ุฎุทุฃ ูู ุฌูุจ ุงูุณุฌู' });
  }
});



app.get('*', (req, res) => {
  res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// --- ุงูุงุชุตุงู ุจู MongoDB ูุชุดุบูู ุงูุฎุงุฏู ---
mongoose
  .connect(process.env.MONGODB_URI)
  .then(() => {
    console.log('โ ุชู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุจูุงูุงุช MongoDB');
    app.listen(PORT, () => {
      console.log(`๐ ุงูุฎุงุฏู ูุนูู ุนูู http://localhost:${PORT}`);
    });
  })
  .catch((err) => {
    console.error('โ ูุดู ุงูุงุชุตุงู ุจู MongoDB:', err);
    process.exit(1);
  });
